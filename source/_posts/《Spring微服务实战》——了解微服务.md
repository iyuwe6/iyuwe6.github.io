---
title: 《Spring微服务实战》——了解微服务
date: 2019-01-04 11:39:20
tags: 
  - SpringCloud
  - 微服务
categories: 
  - 微服务
---

为了应对不断涌现的新技术和新方案，很多公司使用微服务开发软件来为客户搭建和交付解决方案。微服务是松耦合的分布式软件服务，这些服务执行少量的定义明确的任务。
<!--more-->
### 1.什么是微服务？
微服务是一个小的、松耦合的分布式服务。微服务允许将大型代码分解为小型的精确定义的部分，帮助解决大型代码库中传统的复杂问题。信奉的理念：分解和分离应用程序的功能，使他们完全彼此独立。
**微服务架构的特征：**

- 应用程序逻辑分解为具有明确定义了职责范围的细粒度组件，这些组件互相协调提供解决方案；
- 每个组件都有一个小的职责领域，并且完全独立部署。微服务应该对业务领域的单个部件负责。此外，一个微服务应该可以跨多个应用程序复用。
- 微服务通信基于一些基本原则，并采用HTTP和JSON这样的轻量级通信协议，在服务消费者和服务提供者之间进行数据交换。
- 服务的底层采用什么技术实现并没有什么影响，因为应用程序始终使用技术中独立的协议进行通信。这意味着构建在微服务之上的应用程序能够使用多种编程语言和技术进行构建。
- 微服务利用其小、独立和分布式的性质，使组织拥有明确责任领域的小型开发团队。这些团队可能为同一个目标工作，如交付一个应用程序，但是每个团队只负责他们在做的服务。
### 2.使用Spring Boot来构建微服务
如图：
![](https://ws1.sinaimg.cn/large/006aBttAly1g1o2dajzmzj30sk0oxwhb.jpg)
### 3.什么是云？
云计算的三种基本模式：
- 基础设施即服务（Infrastructure as a Service, IaaS)；
- 平台即服务（Platform as a Service, PaaS）；
- 软件即服务（Software as a Service, SaaS）。
  除了上述三种核心云平台类型，新的云平台类型也正在出现。包括：
- 函数即服务（Functions as a Service, FaaS）；
- 容器即服务（Container as a Service, CaaS）。
### 4.云和微服务
微服务架构的核心概念之一就是每个服务都被打包和部署为离散的独立制品。服务实例应该迅速启动，服务的每一个实例都是完全相同。微服务将会部署到以下某个环境中：
- 物理服务器————很少见，缺点在于不能快速提高服务器容量，在多个物理服务器之间水平伸缩成本很高。
- 虚拟机镜像————主要方式，优点在于能够快速启动和关闭微服务实例，以响应可伸缩性和服务故障事件。
- 虚拟容器————虚拟机镜像的延伸，将Docker容器（或等效的容器技术）部署到云端。虚拟容器在虚拟机运行。使用虚拟容器，可将单个虚拟机隔离成共享的相同虚拟机镜像的一系列独立进程。
  基于云的微服务的优势是以弹性的概念为中心。
  用于微服务的常见部署拓扑结构：
- 简化的基础设施管理————使用IaaS云计算供应商提供的基础设施，开发人员可以通过简单的API调用来启动和停止新服务。
- 大规模的水平可伸缩性————IaaS云服务提供商允许开发人员快速简便地启动服务的一个或多个实例。这意味着可以快速扩大服务以及绕过表现不佳或出现故障的服务器。
- 通过地理分布实现高冗余————IaaS供应商必然拥有多个数据中心。通过使用IaaS云供应商部署微服务，可以比使用数据中心里的集群拥有更高级别的冗余。
### 5.基于云开发微服务
运行和支持健壮的微服务应用程序（尤其是在云中运行）不只是涉及为服务编写代码，还需要考虑以下几点：
- 大小适当————如何确保正确地划分微服务的大小，以避免微服务承担太多的职责？适当的大小允许快速更改应用程序，并降低整个应用程序中断的总体风险。
- 位置透明————在微服务应用程序中，多个服务实例可以快速启动和关闭时，如何管理服务调用的物理细节？
- 有弹性————如何绕过失败的服务，确保采取“快速失败”的方法来保护微服务消费者和应用程序的整体完整性？
- 可重复————如何确保提供的每个新服务实例与生产环境中的所有其他服务实例具有相同的配置和代码库？
- 可伸缩————如何使用异步处理和事件来最小化服务之间的直接依赖关系，并确保可以优雅地扩展微服务？
#### 微服务模式
- 核心微服务开发模式
- 微服务路由模式
- 微服务客户端弹性模式
- 微服务安全模式
- 微服务日志记录和跟踪模式
- 微服务构建和部署模式
##### 1.核心微服务开发模式
核心微服务开发模式解决了构建微服务的基础问题。
- 服务粒度————将业务域分解为微服务，使每个微服务都具有适当程度的职责，服务划分粒度不宜过粗，也不宜过细。过粗，导致不同业务问题领域重叠，慢慢地变得难以维护。过细，导致应用程序的整体复杂性增加，使服务变为无逻辑的（除了访问数据存储所需的逻辑）“哑”数据抽象层。
- 通信协议————开发人员可使用XML、JSON或诸如Thrift之类的二进制协议来与微服务传输数据。JSON是微服务的理想选择，并且已成为向微服务发送和接收数据的最常见选择。
- 接口设计————精心设计的微服务接口会使服务变得更加直观。
- 服务的配置管理————管理微服务的配置，以便在不同的云环境之间移动时，不必更改核心应用程序代码或配置。
- 服务之间的事件处理————使用事件解耦微服务，以便最小化服务之间的硬编码依赖关系，并提高应用程序的弹性。
##### 2.微服务路由模式
微服务路由模式负责处理希望消费微服务的客户端应用程序，使客户端应用程序发现服务的位置并路由到服务。
如图：
![](https://ws1.sinaimg.cn/large/006aBttAly1g1o2eld1uvj30n40jvdhb.jpg)
##### 3.微服务客户端弹性模式
微服务架构是高度分布式的，要防止单个服务（或服务实例）中的问题级联暴露给服务的消费者。
4种客户端弹性模式：
- 客户端负载均衡————在服务客户端上缓存服务实例的位置，以便对微服务的多个实例的调用负载均衡到该微服务的所有健康实例。
- 断路器模式————阻止客户继续调用出现故障的或遭遇性能问题的服务。如果服务运行缓慢，客户端调用时会消耗它的资源。开发人员希望出现故障的微服务嗲用能够快速失败，以便主叫客户端可以快速响应并采取适当的措施。
- 后备模式————当服务调用失败时，提供“插件”机制，允许服务的客户端尝试通过调用微服务之外的其他方法来执行工作。
- 舱壁模式————微服务应用程序使用多个分布式资源来执行工作。区分这些调用，使表示不佳的服务调用不会对应用程序的其他部分产生负面影响。

如图：
![](https://ws1.sinaimg.cn/large/006aBttAly1g1o2f899prj30jd0ldmyz.jpg)
使用微服务时，必须保护服务调用者远离表现不佳的服务。记住，慢速或无响应的服务所造成的中断并不仅仅局限于直接关联的服务。
##### 4.微服务安全模式
3种基本的安全模式：
- 验证————确定调用服务的客户端就是它们声称的主体。
- 授权————确定调用微服务的客户端是否允许执行它们正在进行的操作。
- 凭据管理与传播————避免客户端每次都要提供凭据信息才能访问事物中涉及的服务调用。

如图：
![](https://ws1.sinaimg.cn/large/006aBttAly1g1o2gb0wibj30n30iw406.jpg)
使用基于令牌的安全方案，可以实现服务验证和授权，而无须传递客户端凭据。
##### 5.微服务日志记录和跟踪模式
微服务架构的优点是单体应用程序被分解成可以彼此独立部署的小的功能部件，而它的缺点是调试和跟踪应用程序和服务中发生的事情要困难得多。
3种核心日志记录和跟踪模式：
- 日志关联————一个用户事务会调用多个服务，要将这些服务所生成的日志关联到一起，通过唯一的标识符的关联ID，在事务中调用所有服务都会携带它，通过它能够将每个服务生成的日志条目联系起来。
- 日志聚合————将微服务（及其各个实例）生成的所有日志合并到一个可查询的数据库中。
- 微服务跟踪————在涉及的所有服务中可视化客户端事务的流程，并了解事务所涉及的服务的性能特征。

如图：
![](https://ws1.sinaimg.cn/large/006aBttAly1g1o2h05hjoj30pa0i7abr.jpg)
一个深思熟虑的日志记录和跟踪策略使跨多个服务的调试事务变得可管理。
##### 6.微服务构建和部署模式
微服务架构的核心原则之一是，微服务的每个实例都应该和其他所有实例相同。“配置漂移”（某些文件在部署到服务器之后发生了变化）是不允许出现的，因为这可能会导致应用程序不稳定。
如图：
![](https://ws1.sinaimg.cn/large/006aBttAly1g1o2hk38gsj30tl0mfadb.jpg)
开发人员希望微服务及其运行所需的服务器成为在不同环境间作为整体部署的原子制件。
### 6.使用Spring Cloud构建微服务
将前面介绍的模式映射到实现它们的SpringCloud项目。
**开发模式：**

- 核心微服务模式————SpringBoot

- 配置管理————Spring Cloud Config

- 异步消息处理————Spring Cloud Stream

**路由模式：**

- 服务发现模式————Spring Cloud/ Netflix Eureka

- 服务路由模式————Spring Cloud/ Netflix Zuul

**客户端弹性模式：**

- 客户端负载均衡————Spring Cloud/ Netflix Ribbon

- 断路器模式————Spring Cloud/ Netflix Hystrix

- 后备模式————Spring Cloud/ Netflix Hystrix

- 舱壁模式————Spring Cloud/ Netflix Hystrix

**构建部署模式：**

- 持续集成————Travis Cl

- 基础设施即代码————Docker

- 不可变服务器————Docker

- 凤凰服务器————Travis Cl/ Docker

**日志记录模式：**

- 日志关联————Spring Cloud Sleuth

- 日志聚合————Spring Cloud Sleuth(与Papertrail)

- 微服务跟踪————Spring Cloud Sleuth/ Zipkin

**安全模式：**

- 授权————Spring Cloud Security/ OAuth2

- 验证————Spring Cloud Security/ OAuth2

- 凭据管理和传播————Spring Cloud Security/ OAuth2/ JWT